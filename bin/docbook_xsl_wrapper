#!/usr/bin/env ruby

$LOAD_PATH << File.expand_path(File.dirname(__FILE__) + '/../lib')

require 'tmpdir'
require 'docbook_xsl_wrapper'


options = DocbookXslWrapper::Options.parse(ARGV)

unless File.exist?(options.docbook)
  raise ArgumentError.new("File #{options.docbook} does not exist")
end

doc = DocbookXslWrapper::Validate.new(File.open(options.docbook, 'rb'))
unless doc.valid?
  puts "YOUR DOCBOOK XML IS NOT VALID - PLEASE FIX."
  puts
  puts doc.errors
  exit
end

tmp_dir = Dir.mktmpdir
options.destination = tmp_dir

begin
  puts "Rendering DocBook file #{options.docbook} to #{options.output}\n\n" if options.verbose

  epub = DocbookXslWrapper::Epub.new(options)
  epub.create
ensure
  FileUtils.remove_entry_secure tmp_dir
end
